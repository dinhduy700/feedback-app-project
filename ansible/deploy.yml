- name: Deploy Backend Application
  hosts: ec2-54-179-127-46.ap-southeast-1.compute.amazonaws.com # Will be passed from GitHub Actions
  become: yes

  vars:
    ecr_repo_uri: "{{ ecr_repo_uri }}" # Variable passed from GitHub Actions
    image_tag: "{{ image_tag }}" # Variable passed from GitHub Actions
    aws_region: "ap-southeast-1"
    aws_account_id: "157321763663"

  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Login to Amazon ECR
      shell: >
        aws ecr get-login-password --region {{ aws_region }} |
        docker login --username AWS --password-stdin
        {{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com

    - name: Stop and remove existing container
      docker_container:
        name: backend-app
        state: absent
      ignore_errors: yes

    - name: Pull latest image from ECR
      docker_image:
        name: "{{ ecr_repo_uri }}:{{ image_tag }}"
        source: pull

    - name: Run new container
      docker_container:
        name: backend-app
        image: "{{ ecr_repo_uri }}:{{ image_tag }}"
        state: started
        ports:
          - "3000:3000"
        restart_policy: always
